<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<button onclick="launch(true)">Host</button>
<button onclick="launch(false)">Join</button>
<hr>
<input type="text" id="receiver-id" title="Input the host's ID">
<button id="connect-button">Connect</button>
<hr>
<input type="text" id="sendMessageBox">

<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script type="text/javascript">

function launch(isHost) {
    var peer = null;
    var conn = null;
    var peerId = null;
    var lastPeerId = null;
    var sendMessageBox = document.getElementById("sendMessageBox");
    var recvIdInput = document.getElementById("receiver-id");
    var connectButton = document.getElementById("connect-button");

    /**
     * Create the Peer object for our end of the connection.
     *
     * Sets up callbacks that handle any events related to our
     * peer object.
     */
    function initialize() {
        peer = new Peer(null, {
            debug: 2
        });

        /////////////////////////////
        // PEER ON OPEN
        ////////////////////////////
        peer.on('open', function (id) {
            // Workaround for peer.reconnect deleting previous id
            if (peer.id === null) {
                console.log('Received null id from peer open');
                peer.id = lastPeerId;
            } else {
                lastPeerId = peer.id;
            }

            console.log('ID: ' + peer.id);
        });

        /////////////////////////////
        // PEER ON CONNECTION
        ////////////////////////////
        peer.on('connection', function (c) {
            if (!isHost) {
                // Disallow incoming connections if not host
                c.on('open', function() {
                    c.send("Sender does not accept incoming connections");
                    setTimeout(function() { c.close(); }, 500);
                });
                return;
            }

            // Allow only a single connection
            if (conn && conn.open) {
                c.on('open', function() {
                    c.send("Already connected to another client");
                    setTimeout(function() { c.close(); }, 500);
                });
                return;
            }

            conn = c;
            console.log("Connected to: " + conn.peer);
            ready();
        });

        /////////////////////////////
        // PEER ON DISCONNECTED
        ////////////////////////////
        peer.on('disconnected', function () {
            console.log('Connection lost. Please reconnect');

            // Workaround for peer.reconnect deleting previous id
            peer.id = lastPeerId;
            peer._lastServerId = lastPeerId;
            peer.reconnect();
        });

        /////////////////////////////
        // PEER ON CLOSE
        ////////////////////////////
        peer.on('close', function() {
            conn = null;
            console.log('Connection destroyed');
        });

        /////////////////////////////
        // PEER ON ERROR
        ////////////////////////////
        peer.on('error', function (err) {
            console.log(err);
            alert('' + err);
        });
    }; ////// END INITIALIZE

    /**
     * Triggered once a connection has been made to the host.
     * Defines callbacks to handle incoming data and connection events.
     */
    function ready() {
        conn.on('data', function (data) {
            console.log("Data recieved: " + data);
        });
        conn.on('close', function () {
            console.log("connection closed");
            conn = null;
        });
    }

    /**
     * Create the connection to the host.
     * Called by the peer connecting to the host
     * Sets up callbacks that handle any events related to the
     * connection and data received on it.
     */
    function join() {
        // Close old connection
        if (conn) {
            conn.close();
        }

        // Create connection to destination peer specified in the input field
        conn = peer.connect(recvIdInput.value, {
            reliable: true
        });

        conn.on('open', function () {
            console.log("Connected to: " + conn.peer);
        });
        // Handle incoming data (messages only since this is the signal sender)
        conn.on('data', function (data) {
            console.log("data received: " + data);
        });
        conn.on('close', function () {
            console.log("connection closed");
        });
    };

    // Listen for enter in message box
    sendMessageBox.addEventListener('keypress', function (e) {
        var event = e || window.event;
        var char = event.which || event.keyCode;
        if (char == '13')
            sendData(sendMessageBox.value);
    });

    // Send message
    function sendData(data) {
        if (conn && conn.open) {
            sendMessageBox.value = "";
            conn.send(data);
            console.log("Sent: " + data)
        } else {
            console.log('Connection is closed');
        }
    };

    if (!isHost) connectButton.addEventListener('click', join);
    initialize();
}

</script>
</body>
</html>
-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
</head>
<body>
<script type="text/javascript" src="./target/scala-2.13/peer-scalajs-jsdeps.js"></script>
<script type="text/javascript" src="./target/scala-2.13/peer-scalajs-fastopt.js"></script>
</body>
</html>
